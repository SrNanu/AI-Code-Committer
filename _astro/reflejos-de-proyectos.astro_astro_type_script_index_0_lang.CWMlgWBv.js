let i=[];const v=document.getElementById("name"),w=document.getElementById("start"),T=document.getElementById("end"),M=document.getElementById("color"),B=document.getElementById("style"),V=document.getElementById("addBtn"),A=document.getElementById("addAndSelectBtn"),O=document.getElementById("clearBtn"),j=document.getElementById("exportBtn"),y=document.getElementById("itemsContainer"),l=document.getElementById("timelineCanvas"),o=l.getContext("2d");let d=Math.max(1,window.devicePixelRatio||1);const c={left:80,right:20,top:40,bottom:40};let m=null,g=null,u=null;function p(){return new Date().toISOString().slice(0,10)}function I(e,t){const n=new Date(e+"T00:00:00");return n.setDate(n.getDate()+t),n.toISOString().slice(0,10)}w.value=p();T.value=I(w.value,7);function b({name:e,start:t,end:n,color:a,style:r}){const f=i.length*48;i.push({id:Date.now()+Math.random(),name:e,start:new Date(t+"T00:00:00"),end:new Date(n+"T00:00:00"),color:a,style:r,y:f}),D(),h(),E()}function E(){y.innerHTML="",i.forEach((e,t)=>{const n=document.createElement("div");n.className="project-card",n.innerHTML=`
      <div class="swatch" title="${e.color}" style="background:${e.color}; border: 2px solid rgba(0,0,0,0.06)"></div>
      <div class="meta">
        <div class="title">${H(e.name)}</div>
        <div class="dates">${C(e.start)} — ${C(e.end)}</div>
      </div>
      <div class="controls">
        <input type="color" value="${e.color}" data-idx="${t}" class="mini-color">
        <select data-idx="${t}" class="mini-style">
          <option value="solid" ${e.style==="solid"?"selected":""}>Sólido</option>
          <option value="dashed" ${e.style==="dashed"?"selected":""}>Discontinuo</option>
        </select>
        <button class="btn small danger" data-remove="${t}">Eliminar</button>
      </div>
    `,n.addEventListener("click",a=>{a.target.closest("button")||a.target.matches("input")||a.target.matches("select")||(L(t),highlightCard(t))}),y.appendChild(n)}),y.querySelectorAll(".mini-color").forEach(e=>{e.addEventListener("input",t=>{const n=parseInt(t.target.dataset.idx);i[n].color=t.target.value,h()})}),y.querySelectorAll(".mini-style").forEach(e=>{e.addEventListener("change",t=>{const n=parseInt(t.target.dataset.idx);i[n].style=t.target.value,h()})}),y.querySelectorAll("[data-remove]").forEach(e=>{e.addEventListener("click",t=>{const n=parseInt(t.target.getAttribute("data-remove"));i.splice(n,1),D(),h(),E()})})}function L(e){const t=i[e];v.value=t.name,w.value=t.start.toISOString().slice(0,10),T.value=t.end.toISOString().slice(0,10),M.value=t.color,B.value=t.style}function H(e){return(e+"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function C(e){return e.toISOString().slice(0,10)}function D(){if(i.length===0){const a=new Date;m=new Date(a),m.setDate(m.getDate()-7),g=new Date(a),g.setDate(g.getDate()+21);return}let e=i[0].start,t=i[0].end;i.forEach(a=>{a.start<e&&(e=a.start),a.end>t&&(t=a.end)});const n=Math.max(3,Math.round((t-e)/(1e3*60*60*24)*.1));m=new Date(e),m.setDate(m.getDate()-n),g=new Date(t),g.setDate(g.getDate()+n)}function x(e){const t=m.getTime(),n=g.getTime(),a=(e.getTime()-t)/(n-t),r=l.width/d;return c.left+a*(r-c.left-c.right)}function S(e){const t=l.width/d,n=(e-c.left)/(t-c.left-c.right),a=m.getTime()+n*(g.getTime()-m.getTime());return new Date(a)}function q(){o.clearRect(0,0,l.width,l.height)}function z(){l.width/d;const e=l.height/d,t=Math.max(1,Math.round((g-m)/(1e3*60*60*24))),n=Math.min(10,Math.max(4,Math.round(t/7))),a=Math.ceil(t/n);o.save(),o.translate(.5,.5),o.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--card-border")||"#e6e6e6",o.lineWidth=1,o.font=`${.9}rem ${getComputedStyle(document.documentElement).getPropertyValue("--font-family-sans")||"Inter"}`,o.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--text-secondary")||"#6b7280";for(let r=new Date(m),s=0;r<=g;r.setDate(r.getDate()+a,r.getHours()),s++){const f=x(new Date(r));o.beginPath(),o.moveTo(f,c.top),o.lineTo(f,e-c.bottom),o.setLineDash([2,6]),o.stroke(),o.setLineDash([]),o.fillText(r.toISOString().slice(0,10),f+4,c.top-8)}o.restore()}function X(){l.width/d;let e=44;i.forEach((t,n)=>{const a=c.top+n*e+e/2;t.y=a;const r=x(t.start),s=x(t.end);o.save(),o.lineWidth=10,o.lineCap="round",o.strokeStyle=t.color,t.style==="dashed"?o.setLineDash([12,8]):o.setLineDash([]),o.beginPath(),o.moveTo(r,a),o.lineTo(s,a),o.stroke(),o.restore(),o.save(),o.fillStyle=t.color,o.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--card-border"),o.lineWidth=1,o.beginPath(),o.arc(r,a,8,0,Math.PI*2),o.fill(),o.stroke(),o.beginPath(),o.arc(s,a,8,0,Math.PI*2),o.fill(),o.stroke(),o.restore(),o.save(),o.font=`bold 0.9rem ${getComputedStyle(document.documentElement).getPropertyValue("--font-family-sans")}`,o.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--text-color")||"#111827",o.fillText(t.name,r+10,a-12),o.restore()})}function h(){const e=l.getBoundingClientRect();l.width=Math.floor(e.width*d),l.height=Math.floor(e.height*d),o.setTransform(d,0,0,d,0,0),q(),o.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--card-bg")||"#fff",o.fillRect(0,0,l.width/d,l.height/d),z(),X()}function P(e){const t=l.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}function k(e){for(let t=0;t<i.length;t++){const n=i[t],a=x(n.start),r=x(n.end),s=n.y;if(Math.hypot(e.x-a,e.y-s)<=10)return{type:"start",idx:t};if(Math.hypot(e.x-r,e.y-s)<=10)return{type:"end",idx:t};const $=Math.min(a,r)-6,R=Math.max(a,r)+6;if(e.x>=$&&e.x<=R&&Math.abs(e.y-s)<=10)return{type:"move",idx:t}}return null}l.addEventListener("mousedown",e=>{const t=P(e),n=k(t);if(!n)return;const a=i[n.idx];u={type:n.type,idx:n.idx,startX:t.x,origStart:new Date(a.start),origEnd:new Date(a.end)},l.style.cursor="grabbing"});window.addEventListener("mousemove",e=>{const t=P(e);if(u){const n=t.x-u.startX;S(c.left+n)-S(c.left+0);const a=S(c.left+n).getTime()-S(c.left).getTime(),r=i[u.idx];if(u.type==="move")r.start=new Date(u.origStart.getTime()+a),r.end=new Date(u.origEnd.getTime()+a);else if(u.type==="start"){const s=new Date(u.origStart.getTime()+a);s>=r.end?r.start=new Date(r.end.getTime()-1440*60*1e3):r.start=s}else if(u.type==="end"){const s=new Date(u.origEnd.getTime()+a);s<=r.start?r.end=new Date(r.start.getTime()+1440*60*1e3):r.end=s}D(),h()}else{const n=k(t);n?l.style.cursor=n.type==="move"?"grab":"ew-resize":l.style.cursor="default"}});window.addEventListener("mouseup",e=>{u&&(u=null,l.style.cursor="default",E())});V.addEventListener("click",()=>{if(!v.value)return alert("Agrega un nombre para el proyecto");b({name:v.value,start:w.value,end:T.value,color:M.value,style:B.value})});A.addEventListener("click",()=>{if(!v.value)return alert("Agrega un nombre para el proyecto");b({name:v.value,start:w.value,end:T.value,color:M.value,style:B.value}),L(i.length-1)});O.addEventListener("click",()=>{confirm("¿Limpiar todo el gráfico y empezar de nuevo?")&&(i=[],D(),h(),E())});j.addEventListener("click",()=>{const e=document.createElement("canvas"),t=l.getBoundingClientRect();e.width=t.width*d,e.height=t.height*d;const n=e.getContext("2d");n.setTransform(d,0,0,d,0,0),n.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--app-bg")||"#fff",n.fillRect(0,0,t.width,t.height),n.drawImage(l,0,0,t.width,t.height);const a=e.toDataURL("image/png"),r=document.createElement("a");r.href=a,r.download="reflejos-proyectos.png",r.click()});function W(){d=Math.max(1,window.devicePixelRatio||1),h()}window.addEventListener("resize",W);D();h();E();b({name:"Prototype",start:I(p(),-5),end:I(p(),5),color:"#3b82f6",style:"solid"});b({name:"Marketing",start:p(),end:I(p(),20),color:"#ef4444",style:"dashed"});
