(()=>{const o=t=>document.querySelector(t),C=t=>Array.from(document.querySelectorAll(t)),V=t=>{const n=Math.floor(t/60).toString().padStart(2,"0"),i=Math.floor(t%60).toString().padStart(2,"0");return`${n}:${i}`},w={mente:[{id:"m1",title:"Respirar 6 ciclos",instr:"Respira profundo 6 veces, exhalando despacio.",icon:"breath"},{id:"m2",title:"Micro-meditación",instr:"Focaliza la atención en el cuerpo 30s.",icon:"dot"},{id:"m3",title:"Observación",instr:"Escanea tu postura, relaja hombros.",icon:"pulse"},{id:"m4",title:"Visualizar 20s",instr:"Visualiza un color que te calme.",icon:"eye"}],cuerpo:[{id:"c1",title:"Estiramiento",instr:"Estira cuello y hombros lentamente.",icon:"stretch"},{id:"c2",title:"Movilidad",instr:"Gira muñecas, tobillos y hombros.",icon:"wave"},{id:"c3",title:"Pausa de pie",instr:"Levántate y alinea tu columna.",icon:"stand"},{id:"c4",title:"Punto energético",instr:"Presiona ligera palma en pecho.",icon:"dot"}],creatividad:[{id:"cr1",title:"Escribir 1 min",instr:"Anota una idea en 60s.",icon:"pen"},{id:"cr2",title:"Doodle 30s",instr:"Haz un garabato libremente.",icon:"scribble"},{id:"cr3",title:"Asociación",instr:"Relaciona dos ideas opuestas.",icon:"spark"},{id:"cr4",title:"Respirar creativo",instr:"Respira con ritmo y deja fluir.",icon:"breath"}],pausa:[{id:"p1",title:"Mirar fuera",instr:"Mira a lo lejos 20s y parpadea.",icon:"eye"},{id:"p2",title:"Silencio",instr:"Cierra ojos y escucha 30s.",icon:"dot"},{id:"p3",title:"Micro-pausa",instr:"Respira suave y suelta tensión.",icon:"pulse"}]};let e={totalMinutes:5,focus:"mente",intensity:"suave",surprise:!1,pingSound:!0,compact:!1,steps:[],running:!1,currentIndex:0,elapsed:0,timerInterval:null,audioEnabled:!0};const x=o("#duration"),k=o("#durationValue"),st=C(".preset"),S=C(".focus-chip"),L=C(".intensity-btn"),rt=o("#randomizeBtn"),ct=o("#generateBtn"),O=o("#surprise"),G=o("#pingSound"),H=o("#stepsList"),lt=o("#totalTime"),U=o("#compactToggle"),dt=o("#addStep"),ut=o("#startBtn");o("#startBtn");const M=o("#guideOverlay"),pt=o("#closeGuide"),mt=o("#guideTitle"),ft=o("#guideInstruction"),$=o("#guideIcon"),J=o("#timerNumber"),ht=o("#timerFg"),gt=o("#globalProgress"),T=o("#pauseBtn"),vt=o("#skipBtn"),yt=o("#restartBtn"),_=o("#muteBtn"),bt=o("#copyBtn"),Mt=o("#downloadBtn"),Et=o("#shareBtn"),B=o("#note"),wt=o("#savePreset"),xt=o("#loadPreset");function kt(){k.textContent=`${e.totalMinutes} min`,x.value=e.totalMinutes,x.addEventListener("input",t=>{e.totalMinutes=parseInt(t.target.value,10),k.textContent=`${e.totalMinutes} min`}),st.forEach(t=>t.addEventListener("click",()=>{const n=parseInt(t.dataset.min,10);e.totalMinutes=n,x.value=n,k.textContent=`${n} min`})),S.forEach(t=>t.addEventListener("click",()=>{S.forEach(n=>n.classList.remove("active")),S.forEach(n=>n.setAttribute("aria-pressed","false")),t.classList.add("active"),t.setAttribute("aria-pressed","true"),e.focus=t.dataset.focus,K()})),L.forEach(t=>t.addEventListener("click",()=>{L.forEach(n=>n.classList.remove("active")),L.forEach(n=>n.setAttribute("aria-pressed","false")),t.classList.add("active"),t.setAttribute("aria-pressed","true"),e.intensity=t.dataset.int})),O.addEventListener("change",()=>e.surprise=O.checked),G.addEventListener("change",()=>e.pingSound=G.checked),rt.addEventListener("click",()=>{Q(),m("Aleatorización lista")}),ct.addEventListener("click",()=>{R(),m("Ritual generado")}),U.addEventListener("change",()=>{e.compact=U.checked,v()}),dt.addEventListener("click",()=>{St()}),ut.addEventListener("click",()=>{if(e.steps.length===0){m("Genera una secuencia primero",3e3);return}tt()}),pt.addEventListener("click",j),T.addEventListener("click",F),vt.addEventListener("click",et),yt.addEventListener("click",Bt),_.addEventListener("click",()=>{e.audioEnabled=!e.audioEnabled,_.textContent=e.audioEnabled?"🔈":"🔇"}),bt.addEventListener("click",Rt),Mt.addEventListener("click",It),Et.addEventListener("click",Pt),wt.addEventListener("click",qt),xt.addEventListener("click",zt),document.addEventListener("keydown",t=>{M.classList.contains("hidden")||(t.code==="Space"||t.key===" "?(t.preventDefault(),F()):t.key==="Enter"?F():t.key==="ArrowRight"?et():t.key==="Escape"&&j())}),R(),K()}function K(){const t=o("#focusPaletteNote"),n={mente:"Paleta: Serenidad azul",cuerpo:"Paleta: Naturaleza cálida",creatividad:"Paleta: Energía coral",pausa:"Paleta: Neutra suave"};t.textContent=n[e.focus]||"",document.documentElement.setAttribute("data-focus",e.focus)}let A=null;function m(t,n=1500){A&&clearTimeout(A),B.textContent=t,B.classList.remove("hidden"),A=setTimeout(()=>{B.classList.add("hidden")},n)}function X(t){return t[Math.floor(Math.random()*t.length)]}function R(){const t=e.totalMinutes*60;let n=3;e.intensity==="suave"&&(n=2+Math.floor(Math.random()*2)),e.intensity==="medio"&&(n=3+Math.floor(Math.random()*2)),e.intensity==="rapido"&&(n=4+Math.floor(Math.random()*2)),n=Math.max(2,Math.min(5,n));let i=[...w[e.focus]||[]];if(e.surprise){const s=Object.keys(w).filter(N=>N!==e.focus),h=X(s);i=i.concat(w[h].slice(0,2))}const r=[];for(let s=0;s<n&&i.length!==0;s++){const h=i.splice(Math.floor(Math.random()*i.length),1)[0];r.push({...h})}const u=10,l=Math.floor(t/r.length);let a=r.map(()=>l),c=t-l*r.length,d=0;for(;c>0;)a[d%a.length]+=1,d++,c--;for(let s=0;s<a.length;s++)a[s]<u&&(a[s]=u);let p=a.reduce((s,h)=>s+h,0);for(;p>t;){let s=a.indexOf(Math.max(...a));if(a[s]>u)a[s]--,p--;else break}for(;p<t;)a[0]++,p++;e.steps=r.map((s,h)=>({uid:`${s.id}-${Date.now()}-${h}`,title:s.title,instr:s.instr,icon:s.icon,duration:a[h]})),v(),b()}function Q(){const t=e.totalMinutes*60,n=2+Math.floor(Math.random()*4),i=Object.values(w).flat(),r=[];for(let d=0;d<n;d++){const p=X(i);r.push({...p})}const u=Math.floor(t/r.length);let l=r.map(()=>u),a=t-u*l.length,c=0;for(;a>0;)l[c%l.length]++,c++,a--;e.steps=r.map((d,p)=>({uid:`${d.id}-${Date.now()}-${p}`,title:d.title,instr:d.instr,icon:d.icon,duration:l[p]})),v(),b()}function v(){H.innerHTML="",e.steps.forEach((t,n)=>{const i=document.createElement("div");i.className="card",i.dataset.uid=t.uid,i.innerHTML=`
        <div class="card-left">
          <div class="icon-wrap" aria-hidden="true">${W(t.icon)}</div>
        </div>
        <div class="card-main">
          <div class="card-row">
            <div class="card-title" contenteditable="true" data-field="title" aria-label="Editar título">${Y(t.title)}</div>
            <div class="card-duration">
              <input type="number" min="5" step="1" value="${Math.max(5,Math.round(t.duration))}" class="dur-input" aria-label="Duración del paso (segundos)">
              <small>seg</small>
            </div>
          </div>
          <div class="card-instr ${e.compact?"hidden":""}" contenteditable="true" data-field="instr" aria-label="Editar instrucción">${Y(t.instr)}</div>
        </div>
        <div class="card-actions">
          <button class="icon-btn move-up" title="Mover arriba" aria-label="Mover arriba">⬆️</button>
          <button class="icon-btn move-down" title="Mover abajo" aria-label="Mover abajo">⬇️</button>
          <button class="icon-btn duplicate" title="Duplicar" aria-label="Duplicar">⎘</button>
          <button class="icon-btn delete" title="Eliminar" aria-label="Eliminar">🗑</button>
        </div>
      `,H.appendChild(i),i.querySelector(".dur-input").addEventListener("change",a=>{let c=Math.max(5,parseInt(a.target.value,10)||0);t.duration=c,Ct(t.uid),v(),b()}),i.querySelector('[data-field="title"]').addEventListener("input",a=>{t.title=a.target.textContent.trim()}),i.querySelector('[data-field="instr"]').addEventListener("input",a=>{t.instr=a.target.textContent.trim()}),i.querySelector(".move-up").addEventListener("click",()=>{Z(n,n-1)}),i.querySelector(".move-down").addEventListener("click",()=>{Z(n,n+1)}),i.querySelector(".duplicate").addEventListener("click",()=>{Lt(n)}),i.querySelector(".delete").addEventListener("click",()=>{$t(n)})})}function W(t){switch(t){case"breath":return'<svg width="48" height="48" viewBox="0 0 24 24" fill="none" class="mini-icon"><path d="M3 12c3-6 9-8 13-6 4 2 4 8 0 12-4 4-10 2-13-6z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>';case"pulse":return'<svg width="48" height="48" viewBox="0 0 24 24" class="mini-icon"><path d="M2 12h4l2-6 2 12 3-8 3 6h3" stroke="currentColor" stroke-width="1.4" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>';case"dot":return'<svg width="48" height="48" viewBox="0 0 24 24" class="mini-icon"><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>';case"stretch":return'<svg width="48" height="48" viewBox="0 0 24 24" class="mini-icon"><path d="M4 20c4-4 6-9 8-12 2 3 4 8 8 12" stroke="currentColor" stroke-width="1.4" fill="none"/></svg>';case"eye":return'<svg width="48" height="48" viewBox="0 0 24 24" class="mini-icon"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" stroke="currentColor" stroke-width="1.4" fill="none"/><circle cx="12" cy="12" r="2" fill="currentColor"/></svg>';case"pen":return'<svg width="48" height="48" viewBox="0 0 24 24" class="mini-icon"><path d="M3 21l3-1 11-11 2 2-11 11-1 3z" stroke="currentColor" stroke-width="1.4" fill="none"/></svg>';case"scribble":return'<svg width="48" height="48" viewBox="0 0 24 24" class="mini-icon"><path d="M3 12c4 2 6-6 11-4 3 1 3 6 1 8-2 2-6 3-10 1" stroke="currentColor" stroke-width="1.4" fill="none"/></svg>';case"wave":return'<svg width="48" height="48" viewBox="0 0 24 24" class="mini-icon"><path d="M2 12c3-4 5 0 8 0 3 0 5-4 8-4" stroke="currentColor" stroke-width="1.4" fill="none"/></svg>';case"stand":return'<svg width="48" height="48" viewBox="0 0 24 24" class="mini-icon"><path d="M12 2v6M6 22v-4h12v4" stroke="currentColor" stroke-width="1.4" fill="none"/></svg>';case"spark":return'<svg width="48" height="48" viewBox="0 0 24 24" class="mini-icon"><path d="M12 2v4M12 18v4M4.9 4.9l2.8 2.8M16.3 16.3l2.8 2.8" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>';default:return'<svg width="48" height="48" viewBox="0 0 24 24" class="mini-icon"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>'}}function Y(t){return(t||"").replace(/[&<>"']/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[n])}function St(){e.steps.push({uid:`custom-${Date.now()}`,title:"Nuevo paso",instr:"Instrucción breve...",icon:"dot",duration:Math.max(10,Math.floor(e.totalMinutes*60/Math.max(2,e.steps.length+1)))}),I(),v(),b()}function Z(t,n){if(n<0||n>=e.steps.length)return;const[i]=e.steps.splice(t,1);e.steps.splice(n,0,i),v()}function Lt(t){const i={...e.steps[t],uid:`dup-${Date.now()}`};e.steps.splice(t+1,0,i),I(),v(),b()}function $t(t){e.steps.splice(t,1),I(),v(),b()}function I(){const t=e.totalMinutes*60;if(e.steps.length===0)return;let n=Math.floor(t/e.steps.length),i=e.steps.map(()=>n),r=t-n*i.length,u=0;for(;r>0;)i[u%i.length]++,u++,r--;e.steps.forEach((l,a)=>l.duration=i[a])}function Ct(t){const n=e.totalMinutes*60,i=e.steps.find(c=>c.uid===t);if(!i)return;const r=10;let u=n-i.duration;const l=e.steps.filter(c=>c.uid!==t);if(l.length===0){i.duration!==n&&(i.duration=n);return}const a=l.reduce((c,d)=>c+d.duration,0);if(u<l.length*r){m("No hay suficiente tiempo para mantener el resto. Ajustando mínimos.",3e3);const c=l.length*r;c>n&&(i.duration=Math.max(r,n-c),u=n-i.duration),l.forEach(s=>s.duration=r);let d=u-c,p=0;for(;d>0;)l[p%l.length].duration++,p++,d--}else{l.forEach(d=>{const p=d.duration/(a||l.length);d.duration=Math.max(r,Math.round(u*p))});let c=l.reduce((d,p)=>d+p.duration,0);for(;c>u;){let d=l.reduce((p,s)=>s.duration>p.duration?s:p,l[0]);if(d.duration>r)d.duration--,c--;else break}for(;c<u;)l[0].duration++,c++}}function b(){const t=e.steps.reduce((n,i)=>n+Number(i.duration),0);lt.textContent=`${Math.floor(t/60)}m ${t%60}s`}let E=null,y=null,f=null;function tt(){e.running=!0,e.currentIndex=0,e.elapsed=0,M.classList.remove("hidden"),document.body.classList.add("guide-open"),D(),P(0)}function P(t){if(t>=e.steps.length){j(),m("Ritual finalizado",2500);return}e.currentIndex=t;const n=e.steps[t];mt.textContent=n.title,ft.textContent=n.instr,$.innerHTML=W(n.icon),e.focus,o("#guideStageLabel").textContent=`${t+1} / ${e.steps.length}`,E=performance.now(),y=E+n.duration*1e3,z(1),Tt(),e.pingSound&&e.audioEnabled&&D(),At(n),f&&cancelAnimationFrame(f),f=requestAnimationFrame(q)}function q(t){if(!y)return;const n=Math.max(0,(t-E)/1e3),i=Math.max(1,(y-E)/1e3),r=Math.min(1,n/i);J.textContent=V(Math.ceil(i-n)),z(1-r);const u=e.steps.reduce((a,c)=>a+c.duration,0),l=e.steps.slice(0,e.currentIndex).reduce((a,c)=>a+c.duration,0)+n;if(gt.style.width=`${Math.min(100,l/u*100)}%`,t>=y-10&&t>=y-10&&e.pingSound&&e.audioEnabled,t>=y){e.pingSound&&e.audioEnabled&&D(),P(e.currentIndex+1);return}f=requestAnimationFrame(q)}function Tt(){const t=e.steps[e.currentIndex];t&&(J.textContent=V(t.duration),z(1))}function z(t){const n=ht,r=2*Math.PI*50;n.style.strokeDasharray=r,n.style.strokeDashoffset=`${r*t}`}function F(){if(!(!M||M.classList.contains("hidden"))&&e.running)if(f){cancelAnimationFrame(f),f=null;const t=performance.now(),n=y-t;e.pausedRemaining=n,T.textContent="Reanudar"}else{const t=performance.now();E=t,y=t+(e.pausedRemaining||0),e.pausedRemaining=null,T.textContent="Pausa",f=requestAnimationFrame(q)}}function et(){e.running&&P(e.currentIndex+1)}function Bt(){e.running&&tt()}function j(){e.running=!1,f&&cancelAnimationFrame(f),f=null,M.classList.add("hidden"),document.body.classList.remove("guide-open")}let g=null;function D(){if(e.pingSound)try{g||(g=new(window.AudioContext||window.webkitAudioContext));const t=g.createOscillator(),n=g.createGain();t.type="sine",t.frequency.setValueAtTime(880,g.currentTime),n.gain.setValueAtTime(1e-4,g.currentTime),n.gain.exponentialRampToValueAtTime(.05,g.currentTime+.01),n.gain.exponentialRampToValueAtTime(1e-4,g.currentTime+.2),t.connect(n),n.connect(g.destination),t.start(),t.stop(g.currentTime+.22)}catch{}}function At(t){const n=document.querySelector(".guide-card"),i=e.focus,u={mente:["#7dd3fc","#60a5fa"],cuerpo:["#fca5a5","#fb923c"],creatividad:["#fbcfe8","#f472b6"],pausa:["#f3f4f6","#d1fae5"]}[i]||["#e2e8f0","#c7d2fe"];n.style.background=`linear-gradient(135deg, ${u[0]} 0%, ${u[1]} 100%)`,t.icon==="breath"?($.classList.add("pulse"),setTimeout(()=>$.classList.remove("pulse"),Math.min(4e3,t.duration*1e3))):$.classList.remove("pulse")}function Rt(){const t=nt();navigator.clipboard.writeText(t).then(()=>{m("Ritual copiado al portapapeles")}).catch(()=>m("No se pudo copiar"))}function nt(){let t=`Ritual — ${e.totalMinutes} min — ${it(e.focus)}

`;return e.steps.forEach((n,i)=>{t+=`${i+1}. ${n.title} — ${n.duration}s
   ${n.instr}
`}),t}function it(t){return t.charAt(0).toUpperCase()+t.slice(1)}function It(){const i=getComputedStyle(document.documentElement).getPropertyValue("--card-bg")||"#fff",r=getComputedStyle(document.documentElement).getPropertyValue("--accent")||"34,197,94",u=at(frontmatter.title),l=`${e.totalMinutes} min`;let a=`<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400">
      <style>
        .title{font-family:${ot("--font-family-sans")};font-size:28px;fill:rgb(${r});font-weight:700}
        .note{font-family:${ot("--font-family-sans")};font-size:14px;fill:currentColor}
      </style>
      <rect width="100%" height="100%" fill="${i}" rx="16"/>
      <text x="40" y="60" class="title">${u}</text>
      <text x="40" y="92" class="note">Duración: ${l} · ${it(e.focus)}</text>
      `,c=140;e.steps.slice(0,6).forEach((h,N)=>{a+=`<text x="56" y="${c}" class="note">${N+1}. ${at(h.title)} — ${h.duration}s</text>`,c+=32}),a+="</svg>";const d=new Blob([a],{type:"image/svg+xml"}),p=URL.createObjectURL(d),s=document.createElement("a");s.href=p,s.download="ritual.svg",document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(p),m("Tarjeta descargada")}function at(t){return(t||"").replace(/[&<>'"]/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&apos;",'"':"&quot;"})[n])}function ot(t){return getComputedStyle(document.documentElement).getPropertyValue(t)||"Inter, system-ui"}function Pt(){const t=nt();navigator.share?navigator.share({title:frontmatter.title,text:t}).catch(()=>m("Compartir cancelado")):navigator.clipboard.writeText(t).then(()=>m("Texto copiado para compartir"))}function qt(){const t={totalMinutes:e.totalMinutes,focus:e.focus,intensity:e.intensity,steps:e.steps};localStorage.setItem("ritual-fav",JSON.stringify(t)),m("Favorito guardado")}function zt(){const t=localStorage.getItem("ritual-fav");if(!t){m("No hay favorito guardado");return}try{const n=JSON.parse(t);e.totalMinutes=n.totalMinutes||e.totalMinutes,e.focus=n.focus||e.focus,e.intensity=n.intensity||e.intensity,e.steps=n.steps||e.steps,x.value=e.totalMinutes,k.textContent=`${e.totalMinutes} min`,S.forEach(i=>{i.classList.toggle("active",i.dataset.focus===e.focus),i.setAttribute("aria-pressed",i.dataset.focus===e.focus?"true":"false")}),L.forEach(i=>{i.classList.toggle("active",i.dataset.int===e.intensity),i.setAttribute("aria-pressed",i.dataset.int===e.intensity?"true":"false")}),v(),b(),m("Favorito cargado")}catch{m("Error cargando favorito")}}kt(),window._microRitual={state:e,generateSequence:R,randomizeSequence:Q}})();
