(()=>{const g=document.querySelector(".ring"),q=document.getElementById("time-display"),_=document.getElementById("start-30"),u=document.getElementById("pause-resume"),S=document.getElementById("reset"),P=document.getElementById("add-reminder-open"),h=document.getElementById("add-panel"),V=document.getElementById("add-form"),G=document.getElementById("add-cancel"),w=document.getElementById("scheduled-list"),r=document.getElementById("sound-select"),p=document.getElementById("sound-toggle"),v=document.getElementById("reflection-overlay"),L=document.getElementById("close-reflection"),b=2*Math.PI*52;g.style.strokeDasharray=`${b} ${b}`,g.style.strokeDashoffset="0";let y=30,m=y,d=null,f=!0,E=null,l=Z();D();let k=null;function N(){return k||(k=new(window.AudioContext||window.webkitAudioContext)),k}function C(){if(!p.checked||r.value==="none")return;const e=N(),t=e.currentTime,n=[880,660,990].map(c=>c*(Math.random()*.02+.99)),a=e.createGain();a.gain.value=1e-4,a.connect(e.destination),a.gain.exponentialRampToValueAtTime(.3,t+.01),n.forEach((c,i)=>{const s=e.createOscillator(),o=e.createGain();s.type="sine",s.frequency.value=c,o.gain.value=0,s.connect(o),o.connect(a),s.start(t+i*.08),o.gain.setValueAtTime(1e-4,t+i*.08),o.gain.exponentialRampToValueAtTime(.2,t+i*.08+.02),o.gain.exponentialRampToValueAtTime(1e-4,t+i*.08+1.5),s.stop(t+i*.08+1.6)})}function O(){if(!p.checked||r.value!=="ambient")return;const e=N(),t=e.currentTime,n=e.createBuffer(1,e.sampleRate*1.2,e.sampleRate),a=n.getChannelData(0);for(let o=0;o<a.length;o++)a[o]=(Math.random()*2-1)*.2;const c=e.createBufferSource();c.buffer=n;const i=e.createBiquadFilter();i.type="lowpass",i.frequency.value=800,c.connect(i);const s=e.createGain();s.gain.value=1e-4,i.connect(s),s.connect(e.destination),s.gain.exponentialRampToValueAtTime(.25,t+.02),s.gain.exponentialRampToValueAtTime(1e-5,t+1.1),c.start(t),c.stop(t+1.2)}function H(){r.value==="chime"?C():r.value==="ambient"&&O()}function J(e){const t=Math.max(0,Math.floor(e)),n=Math.floor(t/60),a=t%60;return`${String(n).padStart(2,"0")}:${String(a).padStart(2,"0")}`}function T(){const e=Math.max(0,Math.min(1,m/y)),t=b*(1-e);g.style.transition="stroke-dashoffset 0.25s linear",g.style.strokeDashoffset=`${t}`,q.textContent=J(m)}function I(e=30){d&&clearInterval(d),y=e,m=e,f=!1,E=Date.now(),T(),u.disabled=!1,S.disabled=!1,u.textContent="Pause",d=setInterval(Y,100)}function Y(){if(f)return;const e=Date.now(),t=(e-E)/1e3;E=e,m-=t,m<=0?(m=0,T(),K()):T()}function z(){f=!0,u.textContent="Resume"}function j(){f&&(f=!1,E=Date.now(),u.textContent="Pause")}function B(){d&&(clearInterval(d),d=null),y=30,m=y,f=!0,T(),u.disabled=!0,S.disabled=!0,u.textContent="Pause"}function K(){d&&(clearInterval(d),d=null),H(),g.classList.add("finish"),v.setAttribute("aria-hidden","false"),v.style.display="flex",setTimeout(()=>g.classList.remove("finish"),1400)}_.addEventListener("click",()=>{I(30)}),u.addEventListener("click",()=>{f?j():z()}),S.addEventListener("click",()=>{B()}),P.addEventListener("click",()=>{h.setAttribute("aria-hidden","false"),h.style.display="flex"}),G.addEventListener("click",e=>{e.preventDefault(),h.setAttribute("aria-hidden","true"),h.style.display="none"}),V.addEventListener("submit",e=>{e.preventDefault();const t=Math.min(12,Math.max(1,parseInt(document.getElementById("rem-count").value,10)||1)),n=document.getElementById("rem-from").value,a=document.getElementById("rem-to").value;if(!n||!a)return;Q(n,a,t).forEach(i=>{l.push({id:X(),time:i,label:"Satori"})}),x(),D(),F(),h.setAttribute("aria-hidden","true"),h.style.display="none"}),v.addEventListener("click",e=>{e.target===v&&L.click()}),L.addEventListener("click",()=>{v.setAttribute("aria-hidden","true"),v.style.display="none",B()}),document.querySelectorAll(".reflection-actions .btn").forEach(e=>{e.addEventListener("click",()=>{localStorage.setItem("satori-last-feel",e.dataset.feel),L.click()})});function Q(e,t,n){const[a,c]=e.split(":").map(Number),[i,s]=t.split(":").map(Number),o=new Date,U=new Date(o.getFullYear(),o.getMonth(),o.getDate(),a,c,0,0);let A=new Date(o.getFullYear(),o.getMonth(),o.getDate(),i,s,0,0);A<=U&&(A=new Date(A.getTime()+24*3600*1e3));const ee=A-U,$=[];for(let M=0;M<n;M++){const te=new Date(U.getTime()+ee*(M/Math.max(1,n-1)));$.push(te.toISOString())}return $}function D(){if(w.innerHTML="",l.length===0){w.innerHTML='<div class="card empty">No hay momentos programados â€” agrega algunos para empezar.</div>';return}l.sort((e,t)=>new Date(e.time)-new Date(t.time)),l.forEach(e=>{const t=document.createElement("div");t.className="card reminder";const n=new Date(e.time);t.innerHTML=`
        <div class="meta">
          <div class="label">${e.label}</div>
          <div class="time-small">${W(n)}</div>
        </div>
        <div class="rem-actions">
          <button class="btn ghost start-now" data-id="${e.id}">Iniciar ahora</button>
          <button class="btn outline delete" data-id="${e.id}">Eliminar</button>
        </div>
      `,w.appendChild(t)}),document.querySelectorAll(".start-now").forEach(e=>e.addEventListener("click",t=>{I(30)})),document.querySelectorAll(".delete").forEach(e=>e.addEventListener("click",t=>{const n=e.dataset.id;l=l.filter(a=>a.id!==n),x(),D()}))}function W(e){return new Date(e).toLocaleString(void 0,{hour:"2-digit",minute:"2-digit"})}function X(){return Math.random().toString(36).slice(2,9)}function x(){try{localStorage.setItem("satori-scheduled",JSON.stringify(l))}catch{}}function Z(){try{const e=localStorage.getItem("satori-scheduled");return e?JSON.parse(e).map(t=>({...t})):[]}catch{return[]}}let R=null;function F(){R&&clearInterval(R),R=setInterval(()=>{const e=new Date,t=l.filter(n=>{const a=new Date(n.time);return a<=new Date(e.getTime()+2e3)&&a>new Date(e.getTime()-1e3*60*60)});t.length>0&&(t.forEach(n=>{I(30),l=l.filter(a=>a.id!==n.id)}),x(),D())},2e3)}F(),B(),document.addEventListener("keydown",e=>{e.code==="Space"&&document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="SELECT"&&(e.preventDefault(),I(30))}),r.addEventListener("change",()=>{p.checked&&(r.value==="chime"?C():r.value==="ambient"&&O())}),p.addEventListener("change",()=>{localStorage.setItem("satori-sound-on",p.checked?"1":"0")}),r.addEventListener("change",()=>{localStorage.setItem("satori-sound-type",r.value)}),(function(){try{const t=localStorage.getItem("satori-sound-on"),n=localStorage.getItem("satori-sound-type");t!==null&&(p.checked=t==="1"),n&&(r.value=n)}catch{}})()})();
